name: PR Automation Pipeline

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-assign:
    name: PR Assign, Reviewer 자동 설정
    if: ${{ github.event.action == 'opened' || github.event.action == 'ready_for_review' }}
    runs-on: ubuntu-latest
    steps:
      - uses: kentaro-m/auto-assign-action@v2.0.0

  pr-code-analysis:
    name: PR 코드 분석
    needs: [auto-assign]
    if: ${{ always() && (needs.auto-assign.result == 'success' || needs.auto-assign.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: setup java
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "gradle"

      - name: cache gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: chmod gradle
        run: chmod +x gradlew

      - name: run jacocoTestCoverage
        run: ./gradlew jacocoTestCoverage

      - name: set author slack id
        if: always()
        id: author-slack
        run: |
          GIT_ID="${{ github.event.pull_request.user.login }}"

          AUTHOR_NAME="$GIT_ID"
          AUTHOR_ID=""

          if [ "$GIT_ID" == "apptie" ]; then
            AUTHOR_NAME="${{ secrets.apptie_slack_display_name }}"
            AUTHOR_ID="${{ secrets.apptie_slack_id }}"
          elif [ "$GIT_ID" == "gyunnybot" ]; then
            AUTHOR_NAME="${{ secrets.gyunnybot_slack_display_name }}"
            AUTHOR_ID="${{ secrets.gyunnybot_slack_id }}"
          elif [ "$GIT_ID" == "HyNS00" ]; then
            AUTHOR_NAME="${{ secrets.HyNS00_slack_display_name }}"
            AUTHOR_ID="${{ secrets.HyNS00_slack_id }}"
          fi

          echo "AUTHOR_GIT_ID=${GIT_ID}" >> $GITHUB_OUTPUT
          echo "AUTHOR_NAME=${AUTHOR_NAME}" >> $GITHUB_OUTPUT
          echo "AUTHOR_ID=${AUTHOR_ID}" >> $GITHUB_OUTPUT

      - name: set variables
        id: variables
        run: |
          AUTHOR_GIT_ID="${{ steps.author-slack.outputs.AUTHOR_GIT_ID }}"
          AUTHOR_NAME="${{ steps.author-slack.outputs.AUTHOR_NAME }}"
          AUTHOR_ID="${{ steps.author-slack.outputs.AUTHOR_ID }}"

          if [ -n "$AUTHOR_ID" ]; then
            AUTHOR_SLACK_MENTION="<@${AUTHOR_ID}>"
          else
            AUTHOR_SLACK_MENTION="${AUTHOR_NAME}"
          fi

          REVIEWERS_GIT_JSON='${{ toJson(github.event.pull_request.requested_reviewers[*].login) }}'

          if [ "$REVIEWERS_GIT_JSON" == "[]" ] || [ -z "$REVIEWERS_GIT_JSON" ]; then
            reviewers=""
          else
            reviewers=$(echo "$REVIEWERS_GIT_JSON" | jq -r '.[]')
          fi

          REVIEWERS_GIT_ID=""
          REVIEWERS_SLACK_ID=""

          for reviewer in $reviewers; do
            if [ -z "$REVIEWERS_GIT_ID" ]; then
              REVIEWERS_GIT_ID="$reviewer"
            else
              REVIEWERS_GIT_ID="$REVIEWERS_GIT_ID, $reviewer"
            fi

            if [ "$reviewer" == "apptie" ]; then
              REVIEWERS_SLACK_ID+="<@${{ secrets.apptie_slack_id }}> "
            elif [ "$reviewer" == "gyunnybot" ]; then
              REVIEWERS_SLACK_ID+="<@${{ secrets.gyunnybot_slack_id }}> "
            elif [ "$reviewer" == "HyNS00" ]; then
              REVIEWERS_SLACK_ID+="<@${{ secrets.HyNS00_slack_id }}> "
            else
              REVIEWERS_SLACK_ID+="$reviewer "
            fi
          done

          if [ -z "$REVIEWERS_GIT_ID" ]; then
            REVIEWERS_GIT_ID="(none)"
          fi

          if [ -z "$REVIEWERS_SLACK_ID" ]; then
            REVIEWERS_SLACK_ID="(none)"
          fi

          echo "AUTHOR_GIT_ID=${AUTHOR_GIT_ID}" >> $GITHUB_OUTPUT
          echo "AUTHOR_NAME=${AUTHOR_NAME}" >> $GITHUB_OUTPUT
          echo "AUTHOR_ID=${AUTHOR_ID}" >> $GITHUB_OUTPUT
          echo "AUTHOR_SLACK_MENTION=${AUTHOR_SLACK_MENTION}" >> $GITHUB_OUTPUT
          echo "REVIEWERS_GIT_ID=${REVIEWERS_GIT_ID}" >> $GITHUB_OUTPUT
          echo "REVIEWERS_SLACK_ID=${REVIEWERS_SLACK_ID}" >> $GITHUB_OUTPUT

      - name: slack notification
        if: github.event_name == 'pull_request' && github.event.action != 'synchronize'
        run: |
          SLACK_MESSAGE='{"text":"PR 브랜치 분석","blocks":[{"type":"section","text":{"type":"mrkdwn","text":">*PR 브랜치 분석* \n>\n>*PR Author*\n>'
          SLACK_MESSAGE+="${{ steps.variables.outputs.AUTHOR_NAME }}"
          SLACK_MESSAGE+="\n>"
          SLACK_MESSAGE+="(${{ steps.variables.outputs.AUTHOR_GIT_ID }})"
          SLACK_MESSAGE+="\n>\n>*PR 링크*\n><"
          SLACK_MESSAGE+="${{ github.event.pull_request.html_url }}"
          SLACK_MESSAGE+=">\n>\n>*PR 제목*\n>"
          SLACK_MESSAGE+="${{ github.event.pull_request.title }}"
          SLACK_MESSAGE+="\n>\n>분석 결과\n>"
          SLACK_MESSAGE+=":white_check_mark:"
          SLACK_MESSAGE+="\n>\n>*리뷰어(GitHub)*\n>"
          SLACK_MESSAGE+="${{ steps.variables.outputs.REVIEWERS_GIT_ID }}"
          SLACK_MESSAGE+="\n>\n>*리뷰어(Slack)*\n>"
          SLACK_MESSAGE+="${{ steps.variables.outputs.REVIEWERS_SLACK_ID }}"
          SLACK_MESSAGE+='"}}]}'

          curl -X POST ${{ secrets.SLACK_WEBHOOK }} -d "${SLACK_MESSAGE}"

      - name: slack failed notification
        if: failure()
        run: |
          SLACK_MESSAGE='{"text":"PR 브랜치 분석","blocks":[{"type":"section","text":{"type":"mrkdwn","text":">*PR 브랜치 분석* \n>\n>*PR Author*\n>'
          SLACK_MESSAGE+="${{ steps.variables.outputs.AUTHOR_SLACK_MENTION }}"
          SLACK_MESSAGE+="\n>\n>*PR 링크*\n><"
          SLACK_MESSAGE+="${{ github.event.pull_request.html_url }}"
          SLACK_MESSAGE+=">\n>\n>*PR 제목*\n>"
          SLACK_MESSAGE+="${{ github.event.pull_request.title }}"
          SLACK_MESSAGE+="\n>\n>분석 결과\n>"
          SLACK_MESSAGE+=":x:"
          SLACK_MESSAGE+="\n>\n>*리뷰어(Slack)*\n>"
          SLACK_MESSAGE+="${{ steps.variables.outputs.REVIEWERS_SLACK_ID }}"
          SLACK_MESSAGE+='"}}]}'

          curl -X POST ${{ secrets.SLACK_WEBHOOK }} -d "${SLACK_MESSAGE}"

      - name: slack cancelled notification
        if: cancelled()
        run: |
          SLACK_MESSAGE='{"text":"PR 브랜치 분석","blocks":[{"type":"section","text":{"type":"mrkdwn","text":">*PR 브랜치 분석* \n>\n>*PR Author*\n>'
          SLACK_MESSAGE+="${{ steps.variables.outputs.AUTHOR_SLACK_MENTION }}"
          SLACK_MESSAGE+="\n>\n>*PR 링크*\n><"
          SLACK_MESSAGE+="${{ github.event.pull_request.html_url }}"
          SLACK_MESSAGE+=">\n>\n>*PR 제목*\n>"
          SLACK_MESSAGE+="${{ github.event.pull_request.title }}"
          SLACK_MESSAGE+="\n>\n>분석 결과\n>"
          SLACK_MESSAGE+=":black_square_for_stop:"
          SLACK_MESSAGE+="\n>\n>*리뷰어(Slack)*\n>"
          SLACK_MESSAGE+="${{ steps.variables.outputs.REVIEWERS_SLACK_ID }}"
          SLACK_MESSAGE+='"}}]}'

          curl -X POST ${{ secrets.SLACK_WEBHOOK }} -d "${SLACK_MESSAGE}"
