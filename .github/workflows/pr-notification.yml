name: PR Automation Pipeline

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-assign:
    name: PR Assign, Reviewer 자동 설정
    if: ${{ github.event.action == 'opened' || github.event.action == 'ready_for_review' }}
    runs-on: ubuntu-latest
    steps:
      - uses: kentaro-m/auto-assign-action@v2.0.0

  pr-code-analysis:
    name: PR 코드 분석
    needs: [auto-assign]
    if: ${{ always() && (needs.auto-assign.result == 'success' || needs.auto-assign.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: setup java
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "gradle"

      - name: chmod gradlew
        run: chmod +x ./gradlew

      - name: run jacocoTestCoverage
        run: ./gradlew jacocoTestCoverage

      - name: set author slack id
        if: always()
        id: author-slack
        run: |
          GIT_ID="${{ github.event.pull_request.user.login }}"

          AUTHOR_NAME="$GIT_ID"
          AUTHOR_ID=""

          if [ "$GIT_ID" = "apptie" ]; then
            AUTHOR_NAME="${{ secrets.APPTIE_SLACK_DISPLAY_NAME }}"
            AUTHOR_ID="${{ secrets.APPTIE_SLACK_ID }}"
          elif [ "$GIT_ID" = "gyunnybot" ]; then
            AUTHOR_NAME="${{ secrets.GYUNNYBOT_SLACK_DISPLAY_NAME }}"
            AUTHOR_ID="${{ secrets.GYUNNYBOT_SLACK_ID }}"
          elif [ "$GIT_ID" = "HyNS00" ] || [ "$GIT_ID" = "hyns00" ]; then
            AUTHOR_NAME="${{ secrets.HYNS00_SLACK_DISPLAY_NAME }}"
            AUTHOR_ID="${{ secrets.HYNS00_SLACK_ID }}"
          fi

          echo "AUTHOR_GIT_ID=${GIT_ID}" >> $GITHUB_OUTPUT
          echo "AUTHOR_NAME=${AUTHOR_NAME}" >> $GITHUB_OUTPUT
          echo "AUTHOR_ID=${AUTHOR_ID}" >> $GITHUB_OUTPUT

      - name: fetch latest reviewers (GraphQL)
        if: always()
        id: pr-live
        env:
          GH_TOKEN: ${{ github.token }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -e

          read -r -d '' QUERY <<'EOF'
          query($owner:String!, $repo:String!, $number:Int!) {
            repository(owner:$owner, name:$repo) {
              pullRequest(number:$number) {
                reviewRequests(first:100) {
                  nodes {
                    requestedReviewer {
                      __typename
                      ... on User { login }
                      ... on Team { slug }
                    }
                  }
                }
              }
            }
          }
          EOF

          attempts=0
          while true; do
            attempts=$((attempts+1))

            RESP="$(gh api graphql -f query="$QUERY" -f owner="$OWNER" -f repo="$REPO" -F number="$PR_NUMBER")"

            USER_REVIEWERS="$(echo "$RESP" | jq -r '[.data.repository.pullRequest.reviewRequests.nodes[].requestedReviewer | select(.__typename=="User") | .login] | unique | if length==0 then "" else .[] end')"
            TEAM_REVIEWERS="$(echo "$RESP" | jq -r '[.data.repository.pullRequest.reviewRequests.nodes[].requestedReviewer | select(.__typename=="Team") | .slug]  | unique | if length==0 then "" else .[] end')"

            if [ -n "$USER_REVIEWERS" ] || [ -n "$TEAM_REVIEWERS" ] || [ "$attempts" -ge 3 ]; then
              break
            fi

            sleep "$attempts"
          done

          REVIEWERS_SLACK_ID=""

          for user in $USER_REVIEWERS; do
            if [ "$user" = "apptie" ]; then
              REVIEWERS_SLACK_ID+="<@${{ secrets.APPTIE_SLACK_ID }}> "
            elif [ "$user" = "gyunnybot" ]; then
              REVIEWERS_SLACK_ID+="<@${{ secrets.GYUNNYBOT_SLACK_ID }}> "
            elif [ "$user" = "HyNS00" ] || [ "$user" = "hyns00" ]; then
              REVIEWERS_SLACK_ID+="<@${{ secrets.HYNS00_SLACK_ID }}> "
            else
              REVIEWERS_SLACK_ID+="$user "
            fi
          done

          for team in $TEAM_REVIEWERS; do
            REVIEWERS_SLACK_ID+="@${team} "
          done

          if [ -z "$REVIEWERS_SLACK_ID" ]; then
            REVIEWERS_SLACK_ID="(none)"
          fi

          echo "REVIEWERS_SLACK_ID=${REVIEWERS_SLACK_ID}" >> $GITHUB_OUTPUT

      - name: slack notification
        if: always()
        run: |
          STATUS="${{ job.status }}"

          if [ "$STATUS" = "success" ]; then
            ICON=":white_check_mark:"
          elif [ "$STATUS" = "failure" ]; then
            ICON=":x:"
          else
            ICON=":black_square_for_stop:"
          fi

          SLACK_MESSAGE='{"text":"PR 브랜치 분석","blocks":[{"type":"section","text":{"type":"mrkdwn","text":">*PR 브랜치 분석* \n>\n>*PR Author*\n>'
          SLACK_MESSAGE+="${{ steps.author-slack.outputs.AUTHOR_NAME }}"
          SLACK_MESSAGE+="\n>"
          SLACK_MESSAGE+="(${{ steps.author-slack.outputs.AUTHOR_GIT_ID }})"
          SLACK_MESSAGE+="\n>\n>*PR 링크*\n><"
          SLACK_MESSAGE+="${{ github.event.pull_request.html_url }}"
          SLACK_MESSAGE+=">\n>\n>*PR 제목*\n>"
          SLACK_MESSAGE+="${{ github.event.pull_request.title }}"
          SLACK_MESSAGE+="\n>\n>분석 결과\n>"
          SLACK_MESSAGE+="$ICON"
          SLACK_MESSAGE+="\n>\n>*리뷰어*\n>"
          SLACK_MESSAGE+="${{ steps.pr-live.outputs.REVIEWERS_SLACK_ID }}"
          SLACK_MESSAGE+='"}}]}'

          curl -X POST "${{ secrets.SLACK_WEBHOOK }}" -d "${SLACK_MESSAGE}"
